# 2PC与3PC整理
> 2PC，3PC受设计局限没有得到很好的应用，但是学习其基本概念对于理解分布式一致性还是有一定的帮助，本文核心的角度对两个算法进行整理，只为个人记录。
## 2PC
二阶段提交算法：每个参与者将操作成败通知协调者，由协调者控制事务的执行流程，提交或者回滚。
- 准备阶段：协调者将数据操作同步到参与者，参与者根据自身情况对数据进行操作并且将操作的结果返回给协调者。
- 提交阶段：协调者根据上一阶段参与者的反馈状态觉得该阶段执行的行为，只有参与者返回失败的操作，协调者发送指令控制所有的参与者回滚之前 的修改并且终止事务。

### 2PC存在的问题
- 协调者单点问题：可以通过备用的协调者解决，新的协调者通过向所有的参与者请求获取当前的事务状态。
- 同步阻塞
- 数据不一致问题：第二阶段开始时，协调者向所有的参与者发送commit请求后由于网络异常导致部分参与者没有收到commit请求，此时出现了严重的数据不一致问题。
- 容错性问题：二阶段提交协议没有设计较为完善的容错机制，任意一个节点失败都会导致事务的失败

### 3PC
三阶段提交算法在二阶段的基础上将commit阶段分为两个阶段pre_commit与do_commit。
- can_commit：向所有的参与者发送数据操作请求，参与者将执行结果反馈给协调者
- pre_commit：协调者根据所有参与者上一阶段的反馈决定commit还是中断事务（只要有一个节点失败就中断事务），commit阶段将请求发送到参与者，此时事务开始执行，并且记录redo和undo日志，参与者将该阶段执行结果反馈给协调者。
- do_commit：协调者根据pre_commit结果对事务进行中断或者提交。参与者完成事务提交后向协调者发送ack，协调者接受到所有参与者的ack之后完成事务，超时后中断事务。
### 3PC优缺点
解决单点问题，减少阻塞时间，第三阶段参与者没有接收到协调者信息一定时间后会自动提交，不会一直阻塞事务。协调者与部分参与者出现问题不会出现数据不一致问题，节点恢复过来可以进行数据的恢复。但是存在脑裂问题，由于脑裂部分节点无法接收到协调者的回滚指令，出现数据不一致。